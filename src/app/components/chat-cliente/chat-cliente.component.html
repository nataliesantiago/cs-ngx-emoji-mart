<div class="flotante">
  <div class="content">
    <div class="contenedores-chat">
      <!--<button mat-fab color="primary" (click)="openChat()" class="boton-abrir-chat">Chat</button>-->
      <div *ngFor="let chat of chats" class="panel-chat"
        [ngClass]="{'minimizado':chat.minimizado,'agrandado':chat.agrandado}">
        <div fxLayout="row" fxLayoutAlign="center start" class="subpanel">
          <div fxFlex.gt-md="100" fxFlex.gt-sm="100" fxFlex="100" class="hijo">
            <mat-card class="mat-card-top">
              <mat-sidenav-container [hidden]="chat.minimizado"
                [ngClass]="{ 'side-panel-opened': sidePanelOpened, 'side-panel-closed': !sidePanelOpened }"
                class="ventana-chat">

                <mat-toolbar class="no-shadow chat-right-panel-cliente barra-superior"
                  [ngClass]="{'mensajes-nuevos':chat.mensajes_nuevos && chat.id_estado_conversacion==2}" color="basic">


                  <div class="font-14 nombre-asesor" (click)="chat.minimizado=!chat.minimizado">
                    <mat-icon class="icono-mensaje">message</mat-icon>
                    <span *ngIf="!chat.asesor_actual">Chat de experto</span>
                    <span *ngIf="chat.asesor_actual">{{chat.asesor_actual.nombre}}</span>
                  </div>
                  <button mat-icon-button class="ml-1" (click)="chat.minimizado=!chat.minimizado">
                    <mat-icon *ngIf="!chat.minimizado">minimize</mat-icon>
                    <mat-icon *ngIf="chat.minimizado">maximize</mat-icon>
                  </button>
                  <button mat-icon-button class="ml-1 hidden-mobile" (click)="chat.agrandado=!chat.agrandado">
                    <mat-icon class="icono-agrandar">open_in_new</mat-icon>
                  </button>
                  <button [matMenuTriggerFor]="them" mat-icon-button class="ml-1">
                    <mat-icon>more_vert</mat-icon>
                  </button>
                  <mat-menu #them="matMenu" x-position="before">
                    <button mat-menu-item (click)="cerrarChat(chat)">Cerrar Chat</button>
                  </mat-menu>

                </mat-toolbar>
                <div *ngIf="chat.id_experto_actual && !chat.mostrar_encuesta" class="contenedor-grande">
                  <mat-card-content class="chat-middle-box contenedor-mensajes">
                    <perfect-scrollbar class="contenedor" [config]="config" scroll-down="true"
                      refresh-on-change="chat.mensajes" [attr.data-conversacion-id]="chat.codigo" scrollDirective
                      [componentRef]="este" #este [chat]="chat">
                      <div class="panel-buscador-texto" *ngIf="chat.buscando_texto">
                        <div class="contenido-buscador">
                          <input type="text" placeholder="Buscar en la conversación" autofocus
                            [formControl]="chat.texto_busqueda_mensajes" />
                          <div class="cant-matches">{{chat.cant_coincidencias}}</div>
                          <button mat-icon-button title="Cerrar" (click)="chat.buscando_texto=false">
                            <mat-icon>close</mat-icon>
                          </button>
                        </div>
                      </div>

                      <div
                        [ngClass]="{'odd': m.id_usuario!=user.idtbl_usuario,'even': m.id_usuario==user.idtbl_usuario}"
                        *ngFor="let m of chat.mensajes | mensajesExperto: [2,expertos]" class="chat-list">
                        <div class="chat-message">
                          <div class="chat-block" [ngClass]="{'encontrado':m.encontrado && chat.buscando_texto}">
                            <div class="contendor-archivo" *ngIf="m.es_archivo || m.es_nota_voz">
                              <div *ngIf="m.es_archivo">
                                <a [href]="m.url" target="_blank">
                                  <img [src]="m.url" *ngIf="m.tipo_archivo==1" />
                                </a>
                                <video [src]="m.url" controls *ngIf="m.tipo_archivo==2"></video>
                                <div *ngIf="m.tipo_archivo==3" class="archivo-defecto"><a [href]="m.url"
                                    target="_blank">
                                    <mat-icon>attach_file</mat-icon>
                                    {{m.nombre_archivo}}
                                    <span *ngIf="!m.nombre_archivo">Descargar Adjuntos</span>
                                  </a></div>
                              </div>
                              <div *ngIf="m.es_nota_voz">
                                <div class="reproductor-audio" *ngIf="m.audio && m.audioControls">
                                  <button mat-icon-button (click)="toggleAudio(chat,m)">
                                    <mat-icon *ngIf="!m.audioControls.reproduciendo">play_arrow</mat-icon>
                                    <mat-icon *ngIf="m.audioControls.reproduciendo">pause</mat-icon>
                                  </button>
                                  <mat-slider [max]="m.audioControls.max" [min]="m.audioControls.min" [step]="1"
                                    [(ngModel)]="m.audioControls.segundo" (change)="cambiarSegundoAudio(m)">
                                  </mat-slider>
                                  <div class="tiempo-audio"><span>{{m.audioControls.segundo | minuteSeconds}}</span>

                                  </div>

                                </div>
                                <!--<audio [src]="m.url" preload="auto" (loadeddata)="asignarAudio(m,audio)" #audio></audio>-->
                              </div>
                            </div>
                            <div *ngIf="m.es_llamada" class="boton-llamada">
                              <a [href]="m.url" target="_blank">
                                <mat-card><img src="../../assets/images/videollamada.png" />
                                  Unirse! </mat-card>
                              </a>
                            </div>
                            <div *ngIf="!m.es_nota_voz && !m.es_llamada"
                              [innerHTML]="m.texto | linkify | replaceEmojisMensaje:'google' | safe:'html'"> </div>
                            <span *ngIf="m.id_usuario==user.idtbl_usuario">
                              <mat-icon class="icono-burbuja-mensaje" *ngIf="m.estado==1">access_time</mat-icon>
                              <mat-icon class="icono-burbuja-mensaje" *ngIf="m.estado==2">done</mat-icon>
                              <mat-icon class="icono-burbuja-mensaje" *ngIf="m.estado==3">done_all</mat-icon>
                            </span>
                          </div>
                          <span class="foto-mensaje" *ngIf="m.id_usuario!=user.idtbl_usuario && m.user">
                            <img src="{{m.user.url_imagen_gsuite}}" class="img-circle" width="40"
                              title="{{m.user.nombre}}">
                          </span>
                          <div class="chat-date" *ngIf="m.muestra_hora">{{ m.fecha_mensaje | datechat }}</div>
                        </div>
                      </div>
                      <div *ngIf="chat.archivo_adjunto" class="archivo-adjunto">
                        <div class="contenedor-adjunto">
                          <div class="boton-cerrar">
                            <button mat-icon-button color="basic" class=""
                              (click)="quitarArchivoAdjunto(chat,adjuntos)">
                              <mat-icon>close</mat-icon>
                            </button>
                          </div>
                          <img [src]="chat.archivo_adjunto.url" *ngIf="chat.archivo_adjunto.tipo_archivo==1" />
                          <video [src]="chat.archivo_adjunto.url" *ngIf="chat.archivo_adjunto.tipo_archivo==2"></video>
                          <div *ngIf="chat.archivo_adjunto.tipo_archivo==3" class="archivo-defecto"><a
                              [href]="chat.archivo_adjunto.url" target="_blank">
                              <mat-icon>attach_file</mat-icon>
                              {{chat.archivo_adjunto.name}}
                            </a></div>
                          <button mat-icon-button color="basic" class="boton-enviar"
                            (click)="enviarMensaje(chat,2,null,null,este)">
                            <mat-icon>send</mat-icon>
                          </button>
                        </div>
                      </div>
                      <div *ngIf="chat.grabando_nota" class="ventana-grabacion-nota">
                        <div class="contenedor-adjunto">
                          <div class="boton-cerrar">
                            <button mat-icon-button color="basic" class="" (click)="quitarNotaVoz(chat)">
                              <mat-icon>close</mat-icon>
                            </button>
                          </div>
                          <button mat-icon-button color="basic" class="boton-mic">
                            <mat-icon>mic</mat-icon>
                          </button>
                          <div class="cuenta-regresiva">
                            <div>{{chat.cuenta_regresiva}}</div>
                            <div>
                              <button mat-icon-button color="basic" class="boton-enviar"
                                (click)="enviarNota(chat,este)">
                                <mat-icon>send</mat-icon>
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="usuarios-escribiendo"
                        *ngIf="chat.usuarios_escribiendo && chat.usuarios_escribiendo.length>0">
                        <div class="usuario-escribiendo" *ngFor="let u of chat.usuarios_escribiendo">{{u.nombre}} <span
                            *ngIf="u.tipo==1">está
                            escribiendo </span><span *ngIf="u.tipo==2"> está grabando una nota de voz </span>
                          <div class="puntos-escribiendo">
                            <div class="hijo"></div>
                          </div>
                        </div>
                      </div>
                    </perfect-scrollbar>
                    <div *ngIf="chat.llamada_activa" class="ventana-conversacion-activa cliente">
                      <div class="contenedor-llamada">
                        <div class="contenedor-icono">
                          <img src="../../assets/images/videollamada.png" />
                          <div class="contenedor-botones">
                            <div class="contenedor-boton">
                              <a class="custom__btn custom__btn--accept" [href]="chat.url_llamada"
                                target="_blank">Unirse a la
                                llamada</a>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div [hidden]="chat.ocultar_nuevos_mensajes" class="boton-nuevos-mensajes"><button mat-raised-button
                        (click)="verNuevosMensajes(este,chat)" color="basic">Nuevos Mensajes</button></div>
                  </mat-card-content>

                  <mat-card-actions class="chat-footer acciones-chat">

                    <mat-progress-bar mode="indeterminate" *ngIf="chat.cargando_archivo"></mat-progress-bar>
                    <div fxLayout="row" layout-align="start center">
                      <button mat-icon-button color="primary" (click)="toggleEmojis(chat)">
                        <mat-icon aria-label="Example icon-button with a heart icon">tag_faces</mat-icon>
                      </button>
                      <textarea autosize class="input-mensaje" placeholder="Envía un mensaje" [minHeight]="30"  [disabled]="chat.cargando_archivo || chat.grabando_nota  || chat.archivo_adjunto  || chat.iniciando_grabacion"
                        (keydown.enter)="enviarMensaje(chat,1,null,$event,este)" (keydown)="escribiendo(chat,$event)"
                        (keydown.control.f)="buscarTexto(chat,$event,search)" (keyup)="remplazaEmoji(chat)"
                        [(ngModel)]="chat.texto_mensaje" (focus)="setFocus(chat,true)"
                        (blur)="setFocus(chat,false)"></textarea>
                      <button mat-icon-button color="primary" (click)="adjuntos.click()"
                        [disabled]="chat.cargando_archivo || chat.grabando_nota || chat.archivo_adjunto">
                        <mat-icon aria-label="Example icon-button with a heart icon">add_photo_alternate</mat-icon>
                      </button>
                      <button mat-icon-button color="primary" (click)="grabarNotaVoz(chat,este)" *ngIf="chat.notas_voz"
                        [disabled]="chat.cargando_archivo || chat.grabando_nota  || chat.archivo_adjunto  || chat.iniciando_grabacion">
                        <mat-icon aria-label="Example icon-button with a heart icon">mic</mat-icon>
                      </button>
                    </div>
                  </mat-card-actions>
                  <form [hidden]="true" #formulario method="POST" enctype="multipart/form-data" [action]="urlAdjuntos">
                    <input type="file" (change)="adjuntarArchivo(chat,$event,formulario,adjuntos)" #adjuntos />
                  </form>
                </div>
                <div class="panel-buscando-experto" *ngIf="!chat.id_experto_actual && !chat.mostrar_encuesta">
                  <mat-toolbar class="no-shadow bg-green font-family-comunidades barra-buscando" color="green"
                    *ngIf="!chat.no_hay_filas && !chat.no_encontro_experto">
                    <div class="titulo-buscando">{{mensaje_buscando_experto}}</div>
                  </mat-toolbar>

                  <div class="loading-gif" *ngIf="!chat.no_hay_filas && !chat.no_encontro_experto">
                    <img src="assets/images/loading.gif" />
                  </div>

                  <div class="panel-buscando-experto" *ngIf="chat.no_encontro_experto">
                    <mat-toolbar class="no-shadow font-family-comunidades barra-no-encontro" color="green">
                      <div class="titulo-buscando">{{mensaje_no_encontro_experto}}</div>
                    </mat-toolbar>
                  </div>

                </div>

                <perfect-scrollbar class="contenedor-encuesta">
                  <div *ngIf="es_despedida" class="goodbye-message">
                    <h2>{{mensaje_despedida}}</h2>
                  </div>
                  <div *ngIf="chat.cerrado_inactividad" class="goodbye-message">
                    <h2>{{chat.mensaje_inactividad}}</h2>
                  </div>
                  <app-visualizar-encuesta [tipo]="'1'" [chat]="chat" (onfinish)="finalizaEncuesta(chat)">
                  </app-visualizar-encuesta>
                </perfect-scrollbar>

              </mat-sidenav-container>
              <div class="componente-pequeno" [hidden]="!chat.minimizado"
                [ngClass]="{'mensajes-nuevos':chat.mensajes_nuevos}">
                <div class="font-14 nombre-asesor">
                  <mat-icon class="icono-mensaje">message</mat-icon>
                  <span *ngIf="!chat.asesor_actual" (click)="chat.minimizado=!chat.minimizado">Chat de experto</span>
                  <span *ngIf="chat.asesor_actual"
                    (click)="chat.minimizado=!chat.minimizado">{{chat.asesor_actual.nombre}}</span>
                  <button mat-icon-button class="ml-1" (click)="chat.minimizado=false">
                    <mat-icon>maximize</mat-icon>
                  </button>
                </div>

              </div>
            </mat-card>
          </div>
          <emoji-mart set="google" sheetSize="64" class="emojis-panel" perLine="6" *ngIf="chat.mostrar_emojis"
            showPreview="false" (emojiSelect)="seleccionarEmoji($event,chat)"
            [i18n]="{ search: 'Buscar', categories: { search: 'resultados de la búsqueda', recent: 'Recientes' } }">
          </emoji-mart>
        </div>
      </div>
    </div>
  </div>
</div>